<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>身心調適假請假管理系統 v2.3.0 (教師資料維護版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0fdf4;
        }
        
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background-color: white; -webkit-print-color-adjust: exact; }
            .card { box-shadow: none; border: 1px solid #ccc; }
            .print-section { break-inside: avoid; page-break-inside: avoid; }
            .pdf-btn { display: none !important; }
        }
        .print-only { display: none; }

        .loading-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex; justify-content: center; align-items: center;
            z-index: 9999;
            flex-direction: column;
        }
    </style>
</head>
<body class="text-slate-700">

<div id="app" class="min-h-screen flex flex-col">

    <!-- Loading Overlay -->
    <div v-if="isLoading" class="loading-overlay">
        <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-emerald-600 mb-4"></div>
        <div class="text-xl font-bold text-emerald-800">{{ loadingMessage }}</div>
    </div>

    <header class="bg-emerald-600 text-white shadow-md no-print">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2 cursor-pointer" @click="goHome">
                <i class="fa-solid fa-leaf text-xl"></i>
                <h1 class="text-xl font-bold tracking-wide">身心調適假管理系統 <span class="text-xs opacity-75 font-normal">v2.3.0</span></h1>
            </div>
            <div class="space-x-4 text-sm flex items-center">
                <template v-if="currentUser">
                    <span class="mr-2">歡迎，{{ currentUser.name }} 老師</span>
                    <!-- 修改：按鈕改為個人資料維護 -->
                    <button @click="openTeacherProfileModal" class="hover:text-emerald-200 transition underline"><i class="fa-solid fa-user-gear"></i> 個人資料維護</button>
                    <button @click="logout" class="bg-emerald-700 px-3 py-1 rounded hover:bg-emerald-800 transition">登出</button>
                </template>
                <template v-else-if="currentView === 'admin_dashboard'">
                     <span class="mr-2">管理員</span>
                     <button @click="logout" class="bg-emerald-700 px-3 py-1 rounded hover:bg-emerald-800 transition">登出</button>
                </template>
                <template v-else>
                     <button @click="currentView = 'teacher_login'" :class="{'font-bold underline text-white': currentView === 'teacher_login'}" class="hover:text-emerald-100 transition">教師登入</button>
                     <button @click="currentView = 'admin_login'" :class="{'font-bold underline text-white': currentView === 'admin_login'}" class="hover:text-emerald-100 transition">系統管理</button>
                </template>
            </div>
        </div>
        <div v-if="!gasUrl" class="bg-red-100 text-red-800 text-xs text-center py-2 font-bold">
            <i class="fa-solid fa-triangle-exclamation mr-1"></i>尚未設定 Google Apps Script 網址。請開啟 index.html 原始碼，在下方 script 區塊填入您的網址。
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-6">

        <!-- 1. Teacher Login View -->
        <div v-if="currentView === 'teacher_login'" class="max-w-md mx-auto mt-10">
             <div class="bg-white p-8 rounded-lg shadow-lg border-t-4 border-emerald-500">
                <h2 class="text-2xl font-bold mb-6 text-center text-emerald-700">教師登入</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold mb-1">帳號</label>
                        <input type="text" v-model="teacherLogin.account" placeholder="請輸入帳號" class="w-full p-3 border rounded focus:ring-2 focus:ring-emerald-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-1">密碼</label>
                        <input type="password" v-model="teacherLogin.password" placeholder="請輸入密碼" class="w-full p-3 border rounded focus:ring-2 focus:ring-emerald-500 outline-none" @keyup.enter="performTeacherLogin">
                    </div>
                    <button @click="performTeacherLogin" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded shadow">登入</button>
                    
                    <div class="text-center mt-4">
                        <button @click="showForgotPasswordModal = true" class="text-sm text-blue-500 hover:underline">忘記密碼？</button>
                    </div>
                    <p v-if="loginError" class="text-red-500 text-sm text-center mt-2">{{ loginError }}</p>
                </div>
            </div>
        </div>

        <!-- 2. Apply View (Logged In) -->
        <div v-if="currentView === 'apply' && currentUser" class="max-w-4xl mx-auto">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6 border-t-4 border-emerald-500">
                <h2 class="text-2xl font-bold mb-4 text-emerald-700 border-b pb-2">
                    <i class="fa-solid fa-pen-to-square mr-2"></i>申請身心調適假
                </h2>

                <div class="mb-6 bg-slate-50 p-4 rounded-md">
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div class="bg-blue-50 p-3 rounded border border-blue-200">
                            <div class="text-xs text-blue-600">已申請節數</div>
                            <div class="text-2xl font-bold text-blue-800">{{ currentTeacherStats.used }}</div>
                        </div>
                        <div class="bg-emerald-50 p-3 rounded border border-emerald-200">
                            <div class="text-xs text-emerald-600">尚可申請節數</div>
                            <div class="text-2xl font-bold text-emerald-800">{{ currentTeacherStats.remaining }}</div>
                        </div>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">申請日期 (系統日)</label>
                            <input type="text" :value="todayDate" disabled class="w-full p-2 bg-gray-100 border rounded cursor-not-allowed text-gray-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">調適假日期</label>
                            <input type="date" v-model="form.leaveDate" class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-emerald-500">
                        </div>
                    </div>

                    <!-- 操作區塊 -->
                    <div class="bg-orange-50 p-4 rounded border border-orange-200">
                        <label class="block text-sm font-bold mb-1 text-orange-800">
                            <i class="fa-solid fa-1 mr-1"></i>先選擇代課教師
                        </label>
                        <select v-model="form.currentPickerSubId" class="w-full p-2 border border-orange-300 rounded focus:ring-2 focus:ring-orange-500 bg-white">
                            <option value="" disabled>-- 請先在此選擇代課老師 --</option>
                            <option v-for="sub in substitutes" :key="sub.id" :value="sub.id">{{ sub.name }}</option>
                        </select>
                        <p class="text-xs text-orange-600 mt-1">
                            <i class="fa-solid fa-circle-info mr-1"></i>選定後，勾選下方節次，系統將自動填入此代課老師。
                        </p>
                    </div>

                    <div>
                        <label class="block text-sm font-bold mb-2 text-slate-700">
                            <i class="fa-solid fa-2 mr-1"></i>再勾選請假節次
                        </label>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <div v-for="(period, index) in settings.periods" :key="index" 
                                class="border rounded p-3 relative transition-colors duration-200"
                                :class="{'bg-emerald-50 border-emerald-300': isPeriodSelected(period), 'hover:bg-gray-50': !isPeriodSelected(period)}"
                            >
                                <label class="flex items-center space-x-2 cursor-pointer w-full h-full">
                                    <input type="checkbox" 
                                        :checked="isPeriodSelected(period)" 
                                        @click.prevent="togglePeriodSelection(period)"
                                        class="text-emerald-600 focus:ring-emerald-500 rounded h-5 w-5">
                                    <span class="font-medium">{{ period }}</span>
                                </label>
                                
                                <!-- 顯示已選的代課教師 -->
                                <div v-if="form.periodAssignments[period]" class="mt-2 text-center">
                                    <span @click.stop="removeAssignment(period)" 
                                          class="text-blue-600 font-bold text-sm cursor-pointer hover:text-red-500 hover:line-through transition" 
                                          title="點擊以刪除重選">
                                        {{ getSubName(form.periodAssignments[period]) }}
                                        <i class="fa-solid fa-xmark ml-1 text-xs opacity-50"></i>
                                    </span>
                                </div>
                                <div v-else class="mt-2 text-center text-xs text-gray-400 h-5">
                                    (未選)
                                </div>
                            </div>
                        </div>
                    </div>

                    <button @click="submitApplication" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded shadow transition duration-200 flex justify-center items-center">
                        <i class="fa-solid fa-paper-plane mr-2"></i> 確認申請送出
                    </button>
                    <p class="text-xs text-red-500 mt-1 text-center">* 資料送出後即鎖定，需由管理員解鎖後才可編修</p>
                </div>
            </div>

             <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-bold mb-4 text-slate-600">我的申請紀錄</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th class="px-4 py-3">申請日</th>
                                <th class="px-4 py-3">請假日</th>
                                <th class="px-4 py-3">節次</th>
                                <th class="px-4 py-3">代課教師</th>
                                <th class="px-4 py-3">狀態</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="rec in myRecords" :key="rec.id" class="border-b hover:bg-gray-50">
                                <td class="px-4 py-2">{{ rec.applyDate }}</td>
                                <td class="px-4 py-2">{{ formatDate(rec.leaveDate) }}</td>
                                <td class="px-4 py-2">{{ rec.periods.join(', ') }}</td>
                                <td class="px-4 py-2">{{ getSubName(rec.substituteId) }}</td>
                                <td class="px-4 py-2">
                                    <span v-if="rec.locked" class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs">已鎖定</span>
                                    <span v-else class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">可編輯</span>
                                </td>
                            </tr>
                            <tr v-if="myRecords.length === 0">
                                <td colspan="5" class="text-center py-4">目前沒有紀錄</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 3. Admin Login -->
        <div v-if="currentView === 'admin_login'" class="max-w-md mx-auto mt-10">
            <div class="bg-white p-8 rounded-lg shadow-lg border-t-4 border-slate-600">
                <h2 class="text-2xl font-bold mb-6 text-center text-slate-700">系統管理員登入</h2>
                <div class="space-y-4">
                    <input type="text" v-model="login.account" placeholder="帳號 (預設: admin)" class="w-full p-3 border rounded">
                    <input type="password" v-model="login.password" placeholder="密碼 (預設: 094688)" class="w-full p-3 border rounded" @keyup.enter="adminLogin">
                    <button @click="adminLogin" class="w-full bg-slate-700 hover:bg-slate-800 text-white font-bold py-3 rounded">登入</button>
                    <div class="text-center mt-2">
                        <button @click="showForgotPasswordModal = true" class="text-sm text-gray-500 hover:underline">忘記管理員密碼？</button>
                    </div>
                    <p v-if="loginError" class="text-red-500 text-sm text-center">{{ loginError }}</p>
                </div>
            </div>
        </div>

        <!-- 4. Admin Dashboard -->
        <div v-if="currentView === 'admin_dashboard'" class="max-w-6xl mx-auto">
            
            <div class="flex space-x-1 mb-6 border-b border-gray-200 no-print overflow-x-auto">
                <button v-for="tab in adminTabs" :key="tab.id" @click="currentAdminTab = tab.id" 
                    :class="['px-4 py-2 rounded-t-lg font-medium transition whitespace-nowrap', currentAdminTab === tab.id ? 'bg-slate-700 text-white' : 'bg-white text-slate-500 hover:bg-gray-100']">
                    {{ tab.name }}
                </button>
            </div>

            <!-- Settings Tab -->
            <div v-if="currentAdminTab === 'settings'" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                
                <!-- 管理員資料維護 -->
                <div class="bg-white p-6 rounded shadow border-l-4 border-slate-600 md:col-span-2">
                    <h3 class="font-bold text-lg mb-4 border-b pb-2 text-slate-700"><i class="fa-solid fa-user-shield mr-2"></i>管理員資料維護</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-bold mb-1">管理員信箱 (用於找回密碼)</label>
                            <input v-model="settings.adminEmail" placeholder="請輸入 Email" class="w-full p-2 border rounded">
                            <p class="text-xs text-gray-500 mt-1">若忘記密碼，系統將寄送至此信箱。</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded border">
                            <label class="block text-sm font-bold mb-2">修改管理員密碼</label>
                            <div class="space-y-2">
                                <input type="password" v-model="adminProfile.oldPassword" placeholder="原密碼" class="w-full p-2 border rounded text-sm">
                                <input type="password" v-model="adminProfile.newPassword" placeholder="新密碼" class="w-full p-2 border rounded text-sm">
                                <input type="password" v-model="adminProfile.confirmPassword" placeholder="確認新密碼" class="w-full p-2 border rounded text-sm">
                                <button @click="saveAdminProfile" class="w-full bg-slate-600 text-white px-4 py-2 rounded text-sm hover:bg-slate-700 mt-2">更新管理員資料</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded shadow">
                    <h3 class="font-bold text-lg mb-4 border-b pb-2">系統參數設定</h3>
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-1">每人每學期可請領總節數</label>
                        <input type="number" v-model.number="settings.maxQuota" class="w-full p-2 border rounded">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-1">每節代課費用 (元)</label>
                        <input type="number" v-model.number="settings.substituteFee" class="w-full p-2 border rounded">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-1">上課節次表 (逗號分隔)</label>
                        <input type="text" v-model="settings.periodString" class="w-full p-2 border rounded">
                    </div>
                    <button @click="saveSettings" class="bg-emerald-600 text-white px-4 py-2 rounded text-sm hover:bg-emerald-700">儲存參數設定</button>
                </div>

                <div class="bg-white p-6 rounded shadow">
                    <h3 class="font-bold text-lg mb-4 border-b pb-2">教師帳號管理</h3>
                    <div class="flex flex-col gap-2 mb-4 bg-gray-50 p-3 rounded">
                        <div class="text-sm font-bold text-gray-600">新增教師</div>
                        <div class="flex gap-2">
                            <input v-model="newTeacher.name" placeholder="姓名" class="p-2 border rounded w-1/4 text-sm">
                            <input v-model="newTeacher.account" placeholder="帳號" class="p-2 border rounded w-1/4 text-sm">
                            <input v-model="newTeacher.email" placeholder="Email" class="p-2 border rounded w-1/3 text-sm">
                            <button @click="addTeacher" class="bg-green-600 text-white px-2 rounded flex-grow text-sm hover:bg-green-700">新增</button>
                        </div>
                        <p class="text-xs text-gray-500">預設密碼為: 123456</p>
                    </div>
                    <ul class="max-h-80 overflow-y-auto divide-y">
                        <li v-for="t in teachers" :key="t.id" class="py-3 flex justify-between items-center text-sm">
                            <div class="flex flex-col">
                                <span class="font-bold">{{ t.name }} ({{ t.account }})</span>
                                <span class="text-xs text-gray-500">{{ t.email || '未設定 Email' }}</span>
                            </div>
                            <div class="space-x-1">
                                <button @click="openEditTeacherModal(t)" class="text-emerald-600 hover:underline border border-emerald-200 px-2 py-1 rounded text-xs">編輯</button>
                                <button @click="adminResetPassword(t)" class="text-blue-600 hover:underline border px-2 py-1 rounded text-xs">重設密碼</button>
                                <button @click="deleteTeacher(t.id)" class="text-red-500 hover:text-red-700 border border-red-200 px-2 py-1 rounded text-xs">刪除</button>
                            </div>
                        </li>
                    </ul>
                </div>

                <div class="bg-white p-6 rounded shadow md:col-span-2">
                    <h3 class="font-bold text-lg mb-4 border-b pb-2">代課教師管理與維護</h3>
                    <div class="flex gap-2 mb-2 items-center">
                        <input v-model="newSub.name" placeholder="代課教師姓名" class="p-2 border rounded w-1/3">
                        <input v-model="newSub.bankAccount" placeholder="銀行帳戶資料" class="p-2 border rounded w-1/2">
                        <button @click="addSub" class="bg-green-600 text-white px-3 py-2 rounded w-1/6 hover:bg-green-700">新增</button>
                    </div>
                    <div class="flex flex-col gap-2 mt-4 max-h-80 overflow-y-auto">
                        <div v-for="s in substitutes" :key="s.id" class="bg-gray-50 p-3 rounded border flex justify-between items-center text-sm">
                            <div class="flex flex-col">
                                <span class="font-bold text-base">{{ s.name }}</span>
                                <span class="text-gray-500 text-xs"><i class="fa-solid fa-building-columns mr-1"></i>{{ s.bankAccount || '無帳戶資料' }}</span>
                            </div>
                            <div class="space-x-2">
                                <button @click="openEditSubModal(s)" class="text-emerald-600 hover:underline border border-emerald-200 px-2 py-1 rounded text-xs">編輯</button>
                                <button @click="deleteSub(s.id)" class="text-red-500 hover:text-red-600 border border-red-200 px-2 py-1 rounded text-xs">刪除</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Records Tab -->
            <div v-if="currentAdminTab === 'records'" class="bg-white p-6 rounded shadow">
                 <h3 class="font-bold text-lg mb-4 border-b pb-2 flex justify-between items-center">
                    <span>申請紀錄維護 (解鎖/刪除)</span>
                    <span class="text-sm font-normal text-gray-500">共 {{ records.length }} 筆資料</span>
                </h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 uppercase text-xs">
                            <tr>
                                <th class="p-3">教師</th>
                                <th class="p-3">請假日期</th>
                                <th class="p-3">節次</th>
                                <th class="p-3">代課</th>
                                <th class="p-3">狀態</th>
                                <th class="p-3">操作</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">
                            <tr v-for="rec in records" :key="rec.id">
                                <td class="p-3 font-medium">{{ getTeacherName(rec.teacherId) }}</td>
                                <td class="p-3">{{ formatDate(rec.leaveDate) }}</td>
                                <td class="p-3">{{ rec.periods.join(', ') }}</td>
                                <td class="p-3">{{ getSubName(rec.substituteId) }}</td>
                                <td class="p-3">
                                    <span v-if="rec.locked" class="text-red-600 font-bold"><i class="fa-solid fa-lock"></i> 鎖定</span>
                                    <span v-else class="text-green-600 font-bold"><i class="fa-solid fa-lock-open"></i> 已解鎖</span>
                                </td>
                                <td class="p-3 space-x-2">
                                    <button @click="toggleLock(rec)" class="text-blue-600 hover:underline">
                                        {{ rec.locked ? '解鎖' : '鎖定' }}
                                    </button>
                                    <button @click="deleteRecord(rec.id)" class="text-red-600 hover:underline">刪除</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Reports Tab -->
            <div v-if="currentAdminTab === 'reports'" class="space-y-8">
                 <div class="bg-white p-6 rounded shadow no-print mb-4 flex justify-between items-center">
                    <div>
                        <h3 class="font-bold text-lg">報表預覽與下載</h3>
                    </div>
                    <button onclick="window.print()" class="bg-slate-700 text-white px-6 py-2 rounded hover:bg-slate-800 shadow">
                        <i class="fa-solid fa-print mr-2"></i>瀏覽器全頁列印
                    </button>
                </div>

                <!-- Report 1: 教師身心調適假請假總表 -->
                <div id="report-teachers-summary" class="bg-white p-8 border border-gray-300 print-section shadow-sm relative">
                    <div class="flex justify-between items-start mb-6">
                        <h2 class="text-2xl font-bold text-center flex-grow">教師身心調適假請假總表</h2>
                        <button @click="downloadPdf('report-teachers-summary', '教師身心調適假請假總表')" data-html2canvas-ignore class="pdf-btn bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700 flex items-center shadow-md">
                            <i class="fa-solid fa-file-pdf mr-1"></i>下載 PDF
                        </button>
                    </div>
                    <table class="w-full border-collapse border border-gray-400 text-sm">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="border border-gray-400 p-2 w-1/6">教師姓名</th>
                                <th class="border border-gray-400 p-2 w-1/6">請假日期</th>
                                <th class="border border-gray-400 p-2">節次</th>
                                <th class="border border-gray-400 p-2 w-16">節數</th>
                                <th class="border border-gray-400 p-2 w-1/6">代課教師</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="rec in sortedRecords" :key="rec.id">
                                <td class="border border-gray-400 p-2 text-center">{{ getTeacherName(rec.teacherId) }}</td>
                                <td class="border border-gray-400 p-2 text-center">{{ formatDate(rec.leaveDate) }}</td>
                                <td class="border border-gray-400 p-2 text-center">{{ rec.periods.join(', ') }}</td>
                                <td class="border border-gray-400 p-2 text-center">{{ rec.periods.length }}</td>
                                <td class="border border-gray-400 p-2 text-center">{{ getSubName(rec.substituteId) }}</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr class="bg-gray-100 font-bold">
                                <td colspan="3" class="border border-gray-400 p-2 text-right">總計：</td>
                                <td class="border border-gray-400 p-2 text-center text-lg text-emerald-800">{{ totalPeriodsApplied }}</td>
                                <td class="border border-gray-400 p-2"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div class="h-8 print-only"></div> 
                
                <!-- Report 2: 代課教師經費申請總表 -->
                <div id="report-substitutes-summary" class="bg-white p-8 border border-gray-300 print-section shadow-sm relative">
                     <div class="flex justify-between items-start mb-6">
                        <h2 class="text-2xl font-bold text-center flex-grow">代課教師經費申請總表</h2>
                        <button @click="downloadPdf('report-substitutes-summary', '代課教師經費申請總表')" data-html2canvas-ignore class="pdf-btn bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700 flex items-center shadow-md">
                            <i class="fa-solid fa-file-pdf mr-1"></i>下載 PDF
                        </button>
                    </div>
                    <div class="text-right text-xs mb-2 text-gray-500">製表日期: {{ todayDate }}</div>
                    <table class="w-full border-collapse border border-gray-400 text-sm mb-12">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="border border-gray-400 p-2 w-1/5">代理教師姓名</th>
                                <th class="border border-gray-400 p-2">代課日期明細</th>
                                <th class="border border-gray-400 p-2 w-24">代課總節數</th>
                                <th class="border border-gray-400 p-2 w-32">試算金額<br>({{ settings.substituteFee }}元/節)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(data, subId) in substituteReportData" :key="subId">
                                <td class="border border-gray-400 p-2 text-center font-bold">{{ getSubName(subId) }}</td>
                                <td class="border border-gray-400 p-2">
                                    <div v-for="detail in data.details" :key="detail.date" class="flex border-b last:border-0 border-dashed border-gray-300 py-1">
                                        <span class="font-mono mr-2 text-gray-600">{{ formatDate(detail.date) }}:</span>
                                        <span>{{ detail.periods.join(', ') }}</span>
                                    </div>
                                </td>
                                <td class="border border-gray-400 p-2 text-center font-bold text-lg">{{ data.totalPeriods }}</td>
                                <td class="border border-gray-400 p-2 text-right font-mono text-lg">{{ (data.totalPeriods * settings.substituteFee).toLocaleString() }} 元</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr class="bg-gray-100 font-bold border-t-2 border-gray-400">
                                <td colspan="2" class="border border-gray-400 p-2 text-right">合計：</td>
                                <td class="border border-gray-400 p-2 text-center text-lg text-emerald-800">{{ totalSubstituteStats.periods }}</td>
                                <td class="border border-gray-400 p-2 text-right font-mono text-lg text-emerald-800">{{ totalSubstituteStats.amount.toLocaleString() }} 元</td>
                            </tr>
                        </tfoot>
                    </table>

                    <div class="mt-8 grid grid-cols-4 gap-4 text-center">
                        <div class="flex flex-col h-24">
                            <div class="font-bold mb-1">承辦人</div>
                            <div class="flex-grow border-b border-gray-400 mb-2"></div>
                        </div>
                        <div class="flex flex-col h-24">
                            <div class="font-bold mb-1">人事</div>
                            <div class="flex-grow border-b border-gray-400 mb-2"></div>
                        </div>
                        <div class="flex flex-col h-24">
                            <div class="font-bold mb-1">會計</div>
                            <div class="flex-grow border-b border-gray-400 mb-2"></div>
                        </div>
                        <div class="flex flex-col h-24">
                            <div class="font-bold mb-1">校長</div>
                            <div class="flex-grow border-b border-gray-400 mb-2"></div>
                        </div>
                    </div>
                </div>

                <div class="h-8 print-only"></div>

                <!-- Report 3: 身心調適假代課費轉帳清冊 -->
                <div id="report-transfer-list" class="bg-white p-8 border border-gray-300 print-section shadow-sm relative">
                    <div class="flex justify-between items-start mb-6">
                        <h2 class="text-2xl font-bold text-center flex-grow">身心調適假代課費轉帳清冊</h2>
                        <button @click="downloadPdf('report-transfer-list', '身心調適假代課費轉帳清冊')" data-html2canvas-ignore class="pdf-btn bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700 flex items-center shadow-md">
                            <i class="fa-solid fa-file-pdf mr-1"></i>下載 PDF
                        </button>
                    </div>
                    <div class="text-right text-xs mb-2 text-gray-500">製表日期: {{ todayDate }}</div>
                    <table class="w-full border-collapse border border-gray-400 text-sm mb-6">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="border border-gray-400 p-2 w-1/4">代課教師姓名</th>
                                <th class="border border-gray-400 p-2 w-1/2">銀行帳號</th>
                                <th class="border border-gray-400 p-2 w-1/4">代課費用</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="item in transferListData" :key="item.id">
                                <td class="border border-gray-400 p-2 text-center text-base">{{ item.name }}</td>
                                <td class="border border-gray-400 p-2 text-center text-base font-mono">{{ item.bankAccount }}</td>
                                <td class="border border-gray-400 p-2 text-right text-base font-mono">{{ item.fee.toLocaleString() }} 元</td>
                            </tr>
                            <tr v-if="transferListData.length === 0">
                                <td colspan="3" class="border border-gray-400 p-4 text-center">目前無待轉帳資料</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr class="bg-gray-100 font-bold border-t-2 border-gray-400">
                                <td colspan="2" class="border border-gray-400 p-2 text-right">代課費用總計金額：</td>
                                <td class="border border-gray-400 p-2 text-right text-lg font-mono text-emerald-800">{{ totalSubstituteStats.amount.toLocaleString() }} 元</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

        </div>

    </main>
    
    <!-- Forgot Password Modal -->
    <div v-if="showForgotPasswordModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
        <div class="bg-white p-6 rounded-lg w-96 shadow-xl">
            <h3 class="text-xl font-bold mb-4">忘記密碼</h3>
            <p class="text-sm text-gray-600 mb-4">請輸入您的帳號與 Email，系統將會把密碼寄送給您。</p>
            <div class="space-y-3">
                <input v-model="forgotPwd.account" placeholder="請輸入帳號 (管理員請輸 admin)" class="w-full p-2 border rounded">
                <input v-model="forgotPwd.email" placeholder="請輸入 Email" class="w-full p-2 border rounded">
            </div>
            <div class="mt-4 flex justify-end space-x-2">
                <button @click="showForgotPasswordModal = false" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">取消</button>
                <button @click="sendPasswordEmail" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">發送</button>
            </div>
        </div>
    </div>

    <!-- Teacher Profile Modal (個人資料維護) -->
    <div v-if="showTeacherProfileModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
        <div class="bg-white p-6 rounded-lg w-96 shadow-xl max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4 text-emerald-700">個人資料維護</h3>
            <div class="space-y-4">
                <div class="bg-gray-50 p-3 rounded">
                    <p class="text-xs text-gray-500">姓名</p>
                    <p class="font-bold">{{ currentUser.name }}</p>
                </div>
                <div class="bg-gray-50 p-3 rounded">
                    <p class="text-xs text-gray-500">帳號</p>
                    <p class="font-bold">{{ currentUser.account }}</p>
                </div>
                
                <div>
                    <label class="block text-sm font-bold mb-1">Email (用於找回密碼)</label>
                    <input v-model="teacherProfileForm.email" class="w-full p-2 border rounded focus:ring-2 focus:ring-emerald-500">
                </div>

                <div class="border-t pt-4 mt-2">
                    <p class="text-sm font-bold mb-2 text-gray-700"><i class="fa-solid fa-lock mr-1"></i>修改密碼 (若不修改請留空)</p>
                    <div class="space-y-2">
                        <input type="password" v-model="teacherProfileForm.oldPassword" placeholder="原密碼" class="w-full p-2 border rounded text-sm">
                        <input type="password" v-model="teacherProfileForm.newPassword" placeholder="新密碼 (至少4碼)" class="w-full p-2 border rounded text-sm">
                        <input type="password" v-model="teacherProfileForm.confirmPassword" placeholder="確認新密碼" class="w-full p-2 border rounded text-sm">
                    </div>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-2">
                <button @click="showTeacherProfileModal = false" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">取消</button>
                <button @click="saveTeacherProfile" class="px-4 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700">儲存變更</button>
            </div>
        </div>
    </div>

    <!-- Change Password Modal (管理員用/舊版保留) -->
    <div v-if="showChangePasswordModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
        <div class="bg-white p-6 rounded-lg w-96 shadow-xl">
            <h3 class="text-xl font-bold mb-4">修改密碼</h3>
            <div class="space-y-3">
                <div>
                    <label class="text-xs text-gray-500">原密碼</label>
                    <input type="password" v-model="changePwd.old" class="w-full p-2 border rounded">
                </div>
                <div>
                    <label class="text-xs text-gray-500">新密碼</label>
                    <input type="password" v-model="changePwd.new" class="w-full p-2 border rounded">
                </div>
                <div>
                    <label class="text-xs text-gray-500">確認新密碼</label>
                    <input type="password" v-model="changePwd.confirm" class="w-full p-2 border rounded">
                </div>
            </div>
            <div class="mt-4 flex justify-end space-x-2">
                <button @click="showChangePasswordModal = false" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">取消</button>
                <button @click="performChangePassword" class="px-4 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700">確認修改</button>
            </div>
        </div>
    </div>

    <!-- 編輯教師資料 Modal -->
    <div v-if="showEditTeacherModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
        <div class="bg-white p-6 rounded-lg w-96 shadow-xl">
            <h3 class="text-xl font-bold mb-4">編輯教師資料</h3>
            <div class="space-y-3">
                <div>
                    <label class="text-xs text-gray-500">姓名</label>
                    <input v-model="editingTeacher.name" class="w-full p-2 border rounded">
                </div>
                <div>
                    <label class="text-xs text-gray-500">帳號</label>
                    <input v-model="editingTeacher.account" class="w-full p-2 border rounded">
                </div>
                <div>
                    <label class="text-xs text-gray-500">Email</label>
                    <input v-model="editingTeacher.email" class="w-full p-2 border rounded">
                </div>
            </div>
            <div class="mt-4 flex justify-end space-x-2">
                <button @click="showEditTeacherModal = false" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">取消</button>
                <button @click="saveTeacherChanges" class="px-4 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700">儲存</button>
            </div>
        </div>
    </div>

    <!-- 新增：編輯代課教師資料 Modal -->
    <div v-if="showEditSubModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
        <div class="bg-white p-6 rounded-lg w-96 shadow-xl">
            <h3 class="text-xl font-bold mb-4">編輯代課教師資料</h3>
            <div class="space-y-3">
                <div>
                    <label class="text-xs text-gray-500">姓名</label>
                    <input v-model="editingSub.name" class="w-full p-2 border rounded">
                </div>
                <div>
                    <label class="text-xs text-gray-500">銀行帳戶資料</label>
                    <input v-model="editingSub.bankAccount" class="w-full p-2 border rounded">
                </div>
            </div>
            <div class="mt-4 flex justify-end space-x-2">
                <button @click="showEditSubModal = false" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">取消</button>
                <button @click="saveSubChanges" class="px-4 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700">儲存</button>
            </div>
        </div>
    </div>
    
    <footer class="bg-slate-800 text-slate-300 py-4 text-center text-xs no-print">
        &copy; 2025 身心調適假管理系統 | Designed by Vibe Coding
    </footer>

    <audio id="successSound" src="data:audio/wav;base64,UklGRl9vT1BXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"></audio>
</div>

<script>
    const { createApp, ref, computed, reactive, onMounted } = Vue;

    // --- 設定區域 (請在此貼上您的 Google Apps Script 網址) ---
    // 請將您的 GAS Web App URL 填入下方引號中
    const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzinHHcQ-nd7GnFQJ1TiOcd1RRAri9islY5o8NTy20dL4tuig5qZSSvz-X4jGxM-YhIRg/exec'; 
    // 範例: 'https://script.google.com/macros/s/AKfycbzxxxxxxxxxxxxxxxxx/exec'

    createApp({
        setup() {
            // --- 狀態管理 ---
            const currentView = ref('teacher_login'); 
            const currentAdminTab = ref('settings');
            const isLoading = ref(false);
            const loadingMessage = ref('載入中...');
            
            // 用戶狀態
            const currentUser = ref(null); 
            
            // Modals
            const showForgotPasswordModal = ref(false);
            const showChangePasswordModal = ref(false); // Deprecated for teachers, kept for admin logic if needed
            const showTeacherProfileModal = ref(false); // New
            const showEditTeacherModal = ref(false);
            const showEditSubModal = ref(false);
            
            // 使用變數中的 URL
            const gasUrl = ref(GOOGLE_APPS_SCRIPT_URL);

            // 基礎資料
            const teachers = ref([]);
            const substitutes = ref([]);
            const records = ref([]);
            
            // 設定
            const settings = reactive({
                maxQuota: 3,
                substituteFee: 400,
                adminPassword: '094688', 
                adminEmail: '',
                periods: ['第一節', '第二節', '第三節', '第四節', '午休', '第五節', '第六節', '第七節', '第八節'],
                periodString: '第一節,第二節,第三節,第四節,午休,第五節,第六節,第七節,第八節'
            });

            // 表單與登入
            const form = reactive({
                teacherId: '', 
                leaveDate: new Date().toISOString().split('T')[0],
                selectedPeriods: [],
                currentPickerSubId: '',
                periodAssignments: {}
            });

            const login = reactive({ account: '', password: '' });
            const teacherLogin = reactive({ account: '', password: '' });
            const loginError = ref('');

            // 管理員資料修改表單
            const adminProfile = reactive({ oldPassword: '', newPassword: '', confirmPassword: '' });

            // 教師個人資料表單
            const teacherProfileForm = reactive({ email: '', oldPassword: '', newPassword: '', confirmPassword: '' });

            const forgotPwd = reactive({ account: '', email: '' });
            const changePwd = reactive({ old: '', new: '', confirm: '' });
            
            const newTeacher = reactive({ name: '', account: '', email: '' });
            const editingTeacher = reactive({ id: null, name: '', account: '', email: '' });
            
            const newSub = reactive({ name: '', bankAccount: '' }); 
            const editingSub = reactive({ id: null, name: '', bankAccount: '' });

            // --- API 呼叫核心 ---
            const callApi = async (action, data = {}) => {
                if (!gasUrl.value) {
                    console.warn('No Google Sheets URL configured');
                    return null;
                }
                
                try {
                    isLoading.value = true;
                    const response = await fetch(gasUrl.value, {
                        method: 'POST',
                        redirect: 'follow',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({ action, data })
                    });
                    
                    const result = await response.json();
                    if (result.status === 'error') throw new Error(result.message);
                    return result;
                } catch (e) {
                    alert('連線錯誤: ' + e.message);
                    return null;
                } finally {
                    isLoading.value = false;
                }
            };

            const fetchData = async () => {
                if (!gasUrl.value) { initFakeData(); return; }

                loadingMessage.value = '從雲端同步資料中...';
                const result = await callApi('get');
                if (result) {
                    if (result.teachers.length > 0) teachers.value = result.teachers;
                    if (result.substitutes.length > 0) substitutes.value = result.substitutes;
                    if (result.records.length > 0) records.value = result.records;
                    
                    if (result.settings) {
                        if (result.settings.maxQuota) settings.maxQuota = parseInt(result.settings.maxQuota);
                        if (result.settings.substituteFee) settings.substituteFee = parseInt(result.settings.substituteFee);
                        if (result.settings.adminPassword) settings.adminPassword = result.settings.adminPassword;
                        if (result.settings.adminEmail) settings.adminEmail = result.settings.adminEmail;
                        
                        if (result.settings.periodString) {
                            settings.periodString = result.settings.periodString;
                            settings.periods = settings.periodString.split(',').map(s => s.trim()).filter(s => s);
                        }
                    }
                    
                    if (currentUser.value) {
                         const updatedUser = teachers.value.find(t => t.id === currentUser.value.id);
                         if (updatedUser) currentUser.value = updatedUser;
                    }
                }
            };

            const initFakeData = () => {
                teachers.value = [
                    { id: 1, name: '王大明', account: 't001', password: '123', email: 'test1@example.com' },
                    { id: 2, name: '陳小美', account: 't002', password: '123', email: 'test2@example.com' },
                ];
                substitutes.value = [{ id: 1, name: '李代課', bankAccount: '銀行-12345' }, { id: 2, name: '林支援', bankAccount: '' }];
                records.value = [];
            };

            // --- Computed ---
            const todayDate = computed(() => {
                const d = new Date();
                return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
            });

            const currentTeacherStats = computed(() => {
                if (!currentUser.value) return { used: 0, remaining: 0 };
                const used = records.value
                    .filter(r => r.teacherId === currentUser.value.id)
                    .reduce((sum, r) => sum + r.periods.length, 0);
                return { used, remaining: Math.max(0, settings.maxQuota - used) };
            });

            const myRecords = computed(() => {
                if (!currentUser.value) return [];
                return records.value
                    .filter(r => r.teacherId === currentUser.value.id)
                    .sort((a, b) => new Date(b.leaveDate) - new Date(a.leaveDate));
            });

            const sortedRecords = computed(() => {
                return [...records.value].sort((a, b) => {
                    if (a.leaveDate !== b.leaveDate) return new Date(a.leaveDate) - new Date(b.leaveDate);
                    return a.teacherId - b.teacherId;
                });
            });

            const totalPeriodsApplied = computed(() => sortedRecords.value.reduce((acc, curr) => acc + curr.periods.length, 0));

            const substituteReportData = computed(() => {
                const report = {};
                records.value.forEach(rec => {
                    if (!rec.substituteId) return;
                    if (!report[rec.substituteId]) report[rec.substituteId] = { totalPeriods: 0, details: [] };
                    report[rec.substituteId].totalPeriods += rec.periods.length;
                    report[rec.substituteId].details.push({ date: rec.leaveDate, periods: rec.periods });
                });
                for (const subId in report) {
                    report[subId].details.sort((a, b) => new Date(a.date) - new Date(b.date));
                }
                return report;
            });

            const totalSubstituteStats = computed(() => {
                let totalP = 0;
                let totalA = 0;
                Object.values(substituteReportData.value).forEach(data => {
                    totalP += data.totalPeriods;
                });
                totalA = totalP * settings.substituteFee;
                return { periods: totalP, amount: totalA };
            });

            const transferListData = computed(() => {
                return Object.entries(substituteReportData.value).map(([subId, data]) => {
                    const sub = substitutes.value.find(s => s.id == subId);
                    return {
                        id: subId,
                        name: sub ? sub.name : '未知',
                        bankAccount: sub ? sub.bankAccount : '未設定',
                        fee: data.totalPeriods * settings.substituteFee
                    };
                });
            });

            const adminTabs = [
                { id: 'settings', name: '參數與人員設定' },
                { id: 'records', name: '紀錄維護' },
                { id: 'reports', name: '報表列印' }
            ];

            // --- Methods ---

            const formatDate = (val) => {
                if (!val) return '';
                if (typeof val === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(val)) return val;
                const d = new Date(val);
                if (isNaN(d.getTime())) return val;
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            const performTeacherLogin = () => {
                loginError.value = '';
                const teacher = teachers.value.find(t => t.account === teacherLogin.account && t.password == teacherLogin.password);
                
                if (teacher) {
                    currentUser.value = teacher;
                    form.teacherId = teacher.id;
                    currentView.value = 'apply';
                    teacherLogin.password = '';
                } else {
                    loginError.value = '帳號或密碼錯誤';
                }
            };

            const adminLogin = () => {
                const currentAdminPwd = settings.adminPassword || '094688';
                if (login.account === 'admin' && login.password === currentAdminPwd) {
                    currentView.value = 'admin_dashboard';
                    currentUser.value = null; 
                    login.password = '';
                    loginError.value = '';
                } else {
                    loginError.value = '帳號或密碼錯誤';
                }
            };

            const logout = () => {
                currentUser.value = null;
                currentView.value = 'teacher_login';
                loginError.value = '';
            };

            const goHome = () => {
                if(currentUser) currentView.value = 'apply';
                else if (currentView.value !== 'admin_dashboard') currentView.value = 'teacher_login';
            };

            // --- 分次勾選邏輯 ---
            
            const isPeriodSelected = (period) => {
                return form.periodAssignments[period] !== undefined;
            };

            const togglePeriodSelection = (period) => {
                if (isPeriodSelected(period)) {
                    removeAssignment(period);
                } else {
                    if (!form.currentPickerSubId) {
                        alert('請先在上方「選擇代課教師」選單中指定一位老師。');
                        return;
                    }
                    form.periodAssignments[period] = form.currentPickerSubId;
                    form.selectedPeriods.push(period);
                }
            };

            const removeAssignment = (period) => {
                delete form.periodAssignments[period];
                form.selectedPeriods = form.selectedPeriods.filter(p => p !== period);
            };

            const submitApplication = async () => {
                if (!form.leaveDate) return alert('請選擇日期');
                if (form.selectedPeriods.length === 0) return alert('請至少勾選一節課');
                
                if (currentTeacherStats.value.remaining < form.selectedPeriods.length) return alert(`剩餘節數不足！`);

                const groupedPeriods = {};
                for (const period of form.selectedPeriods) {
                    const subId = form.periodAssignments[period];
                    if (!groupedPeriods[subId]) groupedPeriods[subId] = [];
                    groupedPeriods[subId].push(period);
                }

                loadingMessage.value = '正在建立申請單...';
                
                for (const [subId, periods] of Object.entries(groupedPeriods)) {
                    periods.sort((a, b) => settings.periods.indexOf(a) - settings.periods.indexOf(b));

                    const newRecord = {
                        id: Date.now() + Math.floor(Math.random() * 1000), 
                        teacherId: currentUser.value.id,
                        applyDate: todayDate.value,
                        leaveDate: form.leaveDate,
                        periods: periods,
                        substituteId: parseInt(subId), 
                        locked: true
                    };

                    records.value.push(newRecord);
                    if (gasUrl.value) {
                        await callApi('addRecord', newRecord);
                    }
                }
                
                playSuccessSound();
                alert('申請成功！');
                form.selectedPeriods = [];
                form.periodAssignments = {};
            };

            // --- 教師個人資料維護 ---
            const openTeacherProfileModal = () => {
                if (!currentUser.value) return;
                teacherProfileForm.email = currentUser.value.email || '';
                teacherProfileForm.oldPassword = '';
                teacherProfileForm.newPassword = '';
                teacherProfileForm.confirmPassword = '';
                showTeacherProfileModal.value = true;
            };

            const saveTeacherProfile = async () => {
                if (!teacherProfileForm.email) return alert('Email 為必填欄位');
                
                // 準備更新的資料
                const updateData = {
                    id: currentUser.value.id,
                    name: currentUser.value.name,
                    account: currentUser.value.account,
                    email: teacherProfileForm.email
                };

                // 檢查密碼更新
                if (teacherProfileForm.oldPassword || teacherProfileForm.newPassword) {
                    if (teacherProfileForm.oldPassword !== currentUser.value.password) return alert('原密碼錯誤');
                    if (teacherProfileForm.newPassword !== teacherProfileForm.confirmPassword) return alert('新密碼確認不一致');
                    if (teacherProfileForm.newPassword.length < 4) return alert('密碼至少需4碼');
                    
                    updateData.password = teacherProfileForm.newPassword;
                }

                // 更新本地狀態
                const idx = teachers.value.findIndex(t => t.id === currentUser.value.id);
                if (idx !== -1) {
                    teachers.value[idx].email = updateData.email;
                    if (updateData.password) teachers.value[idx].password = updateData.password;
                    // 同步更新 currentUser
                    currentUser.value = { ...teachers.value[idx] };
                }

                // 更新雲端
                if (gasUrl.value) {
                    loadingMessage.value = '更新個人資料中...';
                    await callApi('updateTeacher', updateData);
                }

                alert('個人資料更新成功！');
                showTeacherProfileModal.value = false;
            };

            const openEditTeacherModal = (t) => {
                editingTeacher.id = t.id;
                editingTeacher.name = t.name;
                editingTeacher.account = t.account;
                editingTeacher.email = t.email;
                showEditTeacherModal.value = true;
            };

            const saveTeacherChanges = async () => {
                if(!editingTeacher.name || !editingTeacher.account) return alert('姓名與帳號為必填');
                
                const idx = teachers.value.findIndex(t => t.id === editingTeacher.id);
                if (idx !== -1) {
                    teachers.value[idx].name = editingTeacher.name;
                    teachers.value[idx].account = editingTeacher.account;
                    teachers.value[idx].email = editingTeacher.email;
                    
                    if (gasUrl.value) {
                        loadingMessage.value = '更新資料中...';
                        await callApi('updateTeacher', {
                            id: editingTeacher.id,
                            name: editingTeacher.name,
                            account: editingTeacher.account,
                            email: editingTeacher.email
                        });
                    }
                    alert('更新成功');
                    showEditTeacherModal.value = false;
                }
            };

            const sendPasswordEmail = async () => {
                if (!forgotPwd.account || !forgotPwd.email) return alert('請輸入帳號與 Email');
                
                if (gasUrl.value) {
                    loadingMessage.value = '發送郵件中...';
                    const res = await callApi('sendPasswordEmail', forgotPwd);
                    if (res && res.status === 'success') {
                        alert('郵件已發送，請檢查您的信箱。');
                        showForgotPasswordModal.value = false;
                        forgotPwd.account = '';
                        forgotPwd.email = '';
                    } else {
                         alert(res ? res.message : '發送失敗');
                    }
                } else {
                    alert('尚未連線資料庫，無法發送郵件。(預覽模式不支援發信)');
                }
            };

            const performChangePassword = async () => {
                if (changePwd.old != currentUser.value.password) return alert('舊密碼錯誤');
                if (changePwd.new !== changePwd.confirm) return alert('新密碼確認不一致');
                if (changePwd.new.length < 4) return alert('密碼至少需4碼');

                currentUser.value.password = changePwd.new;
                
                if (gasUrl.value) {
                    loadingMessage.value = '更新密碼中...';
                    await callApi('updateTeacher', currentUser.value);
                }
                
                alert('密碼修改成功！');
                showChangePasswordModal.value = false;
                changePwd.old = ''; changePwd.new = ''; changePwd.confirm = '';
            };

            const adminResetPassword = async (teacher) => {
                const newPwd = prompt(`請輸入 ${teacher.name} 的新密碼:`, "123456");
                if (newPwd !== null) {
                    teacher.password = newPwd;
                    if (gasUrl.value) {
                        loadingMessage.value = '重設密碼中...';
                        await callApi('updateTeacher', teacher);
                    }
                    alert('密碼已重設。');
                }
            };

            const saveSettings = async () => {
                settings.periods = settings.periodString.split(',').map(s => s.trim()).filter(s => s);
                if (gasUrl.value) {
                    loadingMessage.value = '儲存設定中...';
                    await callApi('saveSettings', { 
                        maxQuota: settings.maxQuota,
                        substituteFee: settings.substituteFee,
                        periodString: settings.periodString,
                        adminPassword: settings.adminPassword,
                        adminEmail: settings.adminEmail
                    });
                }
                alert('設定已儲存');
            };

            const saveAdminProfile = async () => {
                if (adminProfile.oldPassword || adminProfile.newPassword) {
                    if (adminProfile.oldPassword !== settings.adminPassword) return alert('原密碼錯誤');
                    if (adminProfile.newPassword !== adminProfile.confirmPassword) return alert('新密碼確認不一致');
                    if (adminProfile.newPassword.length < 4) return alert('密碼長度不足');
                    settings.adminPassword = adminProfile.newPassword;
                }
                await saveSettings();
                adminProfile.oldPassword = '';
                adminProfile.newPassword = '';
                adminProfile.confirmPassword = '';
            };
            
            const addTeacher = async () => {
                if(!newTeacher.name || !newTeacher.account) return alert('請輸入姓名與帳號');
                
                const newItem = { 
                    id: Date.now(), 
                    name: newTeacher.name, 
                    account: newTeacher.account,
                    email: newTeacher.email,
                    password: '123456' 
                };
                teachers.value.push(newItem);
                
                if (gasUrl.value) {
                    loadingMessage.value = '新增教師中...';
                    await callApi('addTeacher', newItem);
                }
                newTeacher.name = ''; newTeacher.account = ''; newTeacher.email = '';
                alert('教師已新增，預設密碼為 123456');
            };

            const deleteTeacher = async (id) => {
                if(confirm('確定刪除此教師？')) {
                    teachers.value = teachers.value.filter(t => t.id !== id);
                    if (gasUrl.value) {
                        loadingMessage.value = '刪除中...';
                        await callApi('deleteTeacher', { id });
                    }
                }
            };
            
            const getTeacherName = (id) => { const t = teachers.value.find(t => t.id == id); return t ? t.name : '未知'; };
            
            const addSub = async () => { 
                if(!newSub.name) return;
                const newItem = { id: Date.now(), name: newSub.name, bankAccount: newSub.bankAccount };
                substitutes.value.push(newItem);
                if (gasUrl.value) { loadingMessage.value = '新增中...'; await callApi('addSub', newItem); }
                newSub.name = '';
                newSub.bankAccount = '';
            };

            const openEditSubModal = (s) => {
                editingSub.id = s.id;
                editingSub.name = s.name;
                editingSub.bankAccount = s.bankAccount || '';
                showEditSubModal.value = true;
            };

            const saveSubChanges = async () => {
                if(!editingSub.name) return alert('姓名為必填');
                
                const idx = substitutes.value.findIndex(s => s.id === editingSub.id);
                if (idx !== -1) {
                    substitutes.value[idx].name = editingSub.name;
                    substitutes.value[idx].bankAccount = editingSub.bankAccount;
                    
                    if (gasUrl.value) {
                        loadingMessage.value = '更新資料中...';
                        await callApi('updateSub', {
                            id: editingSub.id,
                            name: editingSub.name,
                            bankAccount: editingSub.bankAccount
                        });
                    }
                    alert('更新成功');
                    showEditSubModal.value = false;
                }
            };

            const deleteSub = async (id) => {
                if(confirm('確定刪除？')) {
                    substitutes.value = substitutes.value.filter(s => s.id !== id);
                    if (gasUrl.value) { loadingMessage.value = '刪除中...'; await callApi('deleteSub', { id }); }
                }
            };
            const getSubName = (id) => { const s = substitutes.value.find(s => s.id == id); return s ? s.name : '未知'; };
            const toggleLock = async (rec) => { rec.locked = !rec.locked; if (gasUrl.value) { loadingMessage.value = '更新...'; await callApi('updateRecord', rec); } };
            const deleteRecord = async (id) => {
                if(confirm('確定刪除？')) {
                    records.value = records.value.filter(r => r.id !== id);
                    if (gasUrl.value) { loadingMessage.value = '刪除中...'; await callApi('deleteRecord', { id }); }
                }
            };
            const downloadPdf = (elementId, filename) => {
                const element = document.getElementById(elementId);
                const opt = {
                    margin:       10, // mm
                    filename:     filename + '.pdf',
                    image:        { type: 'jpeg', quality: 0.98 },
                    html2canvas:  { 
                        scale: 2, 
                        useCORS: true,
                        scrollY: 0 
                    },
                    jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
                    pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] } 
                };
                isLoading.value = true;
                loadingMessage.value = '產生 PDF...';
                html2pdf().set(opt).from(element).save().then(() => isLoading.value = false).catch(err => { console.error(err); isLoading.value = false; alert('PDF 失敗'); });
            };
            const playSuccessSound = () => { try { const audio = document.getElementById('successSound'); if(audio) { const ctx = new (window.AudioContext || window.webkitAudioContext)(); const osc = ctx.createOscillator(); const gain = ctx.createGain(); osc.connect(gain); gain.connect(ctx.destination); osc.type = 'sine'; osc.frequency.value = 523.25; gain.gain.value = 0.1; osc.start(); gain.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.5); osc.stop(ctx.currentTime + 0.5); } } catch (e) {} };

            onMounted(() => fetchData());

            return {
                currentView, currentAdminTab, isLoading, loadingMessage, gasUrl,
                teachers, substitutes, settings, form, login, teacherLogin, loginError, records,
                newTeacher, editingTeacher, newSub, editingSub, adminTabs, todayDate, currentUser, currentTeacherStats,
                myRecords, sortedRecords, substituteReportData, totalPeriodsApplied,
                totalSubstituteStats, 
                showForgotPasswordModal, showChangePasswordModal, showEditTeacherModal, showEditSubModal, forgotPwd, changePwd,
                showTeacherProfileModal, teacherProfileForm, // 新增
                adminProfile,
                submitApplication, adminLogin, performTeacherLogin, logout, goHome, saveSettings, 
                addTeacher, deleteTeacher, getTeacherName,
                addSub, deleteSub, getSubName, openEditSubModal, saveSubChanges, // 新增
                toggleLock, deleteRecord, downloadPdf,
                sendPasswordEmail, performChangePassword, adminResetPassword,
                openEditTeacherModal, saveTeacherChanges, saveAdminProfile, 
                formatDate, transferListData,
                isPeriodSelected, togglePeriodSelection, removeAssignment, // 新增分次勾選方法
                openTeacherProfileModal, saveTeacherProfile // 新增
            };
        }
    }).mount('#app');
</script>
</body>
</html>